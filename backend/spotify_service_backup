import os
import logging
import spotipy
from spotipy.oauth2 import SpotifyOAuth
from typing import Optional, Dict
from dotenv import load_dotenv

load_dotenv()

# Variaveis
SPOTIFY_CLIENT_ID = os.getenv("SPOTIFY_CLIENT_ID")
SPOTIFY_CLIENTE_SECRET = os.getenv("SPOTIFY_CLIENTE_SECRET")
SPOTIFY_REDIRECT_URI = os.getenv("SPOTIFY_REDIRECT_URI")

SCOPES = [
    "user-read-currently-playing",
    "user-read-playback-state"
    "playlist-modify-public",
    "playlist-modify-private"
]

class SpotifyService:
    # Gerenciar a conexao com o spotify

    def __init__(self):
        self.sp_oauth = None
        self.sp = None
        self._initialize_oauth()
    
    def _initialize_oauth(self):

        if not SPOTIFY_CLIENT_ID or not SPOTIFY_CLIENTE_SECRET:
            logging.info("Credenciais do Spotify n칚o configuradas!")
            return

        self.sp_oauth = SpotifyOAuth(
            client_id = SPOTIFY_CLIENT_ID,
            client_secret = SPOTIFY_CLIENTE_SECRET,
            redirect_uri = SPOTIFY_REDIRECT_URI,
            scope = " ".join(SCOPES),
            cache_path = ".spotify_cache"
        )

    def get_auth_url(self) -> str:
        if not self.sp_oauth:
            raise Exception("Credenciais do Spotify n칚o configuradas!")
        
        return self.sp_oauth.get_authorize_url()
    
    def authenticate_with_code(self, code: str) -> bool:

        if not self.sp_oauth:
            return False
        
        try:
            token_info = self.sp_oauth.get_access_token(code)
            self.sp = spotipy.Spotify(auth=token_info['access_token'])

            return True
        
        except Exception as e:
            print(f"Erro na autentica칞칚o: {e}")

            return False

    def is_authenticated(self) -> bool:
        if not self.sp_oauth:
            return False
        
        token_info = self.sp_oauth.get_cached_token()
        
        if token_info:
            self.sp = spotipy.Spotify(auth=token_info['access_token'])

            return True
        
        return False

    def get_current_track(self) -> Optional[Dict]:

        if not self.sp:
            return None
        
        try:
            current = self.sp.current_playback()
            
            if not current or not current.get('item'):
                return None
            
            track = current['item']
            
            return {
                "track_name": track['name'],
                "artist": ", ".join([artist['name'] for artist in track['artists']]),
                "album": track['album']['name'],
                "spotify_uri": track['uri'],
                "duration_ms": track['duration_ms'],
                "is_playing": current['is_playing']
            }
        
        except Exception as e:
            print(f"Erro ao buscar m칰sica atual: {e}")

            return None

    def create_playlist(self, name: str, track_uris: list) -> Optional[str]:

        if not self.sp:
            return None
        
        try:
            # Pegar ID do usu치rio
            user = self.sp.current_user()
            user_id = user['id']
            
            # Criar playlist
            playlist = self.sp.user_playlist_create(
                user = user_id,
                name = name,
                public = False, 
                description = "Criada pelo CodeQuest 游꿡"
            )
            
            # Adicionar m칰sicas 
            if track_uris:
                # Spotipy aceita no m치ximo 100
                for i in range(0, len(track_uris), 100):
                    batch = track_uris[i:i+100]
                    self.sp.playlist_add_items(playlist['id'], batch)
            
            return playlist['external_urls']['spotify']
        
        except Exception as e:
            print(f"Erro ao criar playlist: {e}")

            return None

    def get_user_info(self) -> Optional[Dict]:

        if not self.sp:
            return None
        
        try:
            user = self.sp.current_user()

            return {
                "display_name": user.get('display_name', 'Usu치rio'),
                "email": user.get('email'),
                "profile_url": user.get('external_urls', {}).get('spotify'),
                "image": user.get('images', [{}])[0].get('url') if user.get('images') else None
            }
        
        except Exception as e:
            print(f"Erro ao buscar info do usu치rio: {e}")

            return None

# Criar uma inst칙ncia 칰nica do servi칞o
spotify_service = SpotifyService()

# Fun칞칚o para obter a inst칙ncia do servi칞o
def get_spotify_service() -> SpotifyService:
    return spotify_service

def format_track_info(track_data: Dict) -> str:

    if not track_data:
        return "Nenhuma m칰sica tocando"
    
    status = "Tocando" if track_data.get('is_playing') else "Pausado"

    return f"{status}: {track_data['track_name']} - {track_data['artist']}"






